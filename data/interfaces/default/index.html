<%inherit file="base.html"/>

<%def name="headIncludes()">
<link href="${http_root}css/jquery.scrollbar.css" rel="stylesheet">
</%def>

<%def name="body()">
<div class="container-fluid">
    % for section in config['home_sections']:
    % if section == 'current_activity':
    <div class="row">
        <div class="col-md-12">
            <div class="padded-header" id="current-activity-header">
                <h3>Activity</h3>
            </div>
            <div id="currentActivity">
                <div class="text-muted" id="dashboard-checking-activity"><i class="fa fa-refresh fa-spin"></i> Checking for activity...</div>
            </div>
        </div>
    </div>
    % elif section == 'watch_stats':
    <div class="row">
        <div class="col-md-12">
            <div class="home-padded-header padded-header">
                <h3 class="pull-left">Watch Statistics</h3>
                <div class="btn-group pull-left" data-toggle="buttons" id="watch-stats-toggles" style="margin-right: 3px">
                    % if config['home_stats_type'] == 0:
                    <label class="btn btn-dark active">
                        <input type="radio" class="watched-stats-toggle" name="watched-stats-type" id="watched-stats-plays" value="0" autocomplete="off" checked> Play Count
                    </label>
                    <label class="btn btn-dark">
                        <input type="radio" class="watched-stats-toggle" name="watched-stats-type" id="watched-stats-duration" value="1" autocomplete="off"> Play Duration
                    </label>
                    % else:
                    <label class="btn btn-dark">
                        <input type="radio" class="watched-stats-toggle" name="watched-stats-type" id="watched-stats-plays" value="0" autocomplete="off"> Play Count
                    </label>
                    <label class="btn btn-dark active">
                        <input type="radio" class="watched-stats-toggle" name="watched-stats-type" id="watched-stats-duration" value="1" autocomplete="off" checked> Play Duration
                    </label>
                    % endif
                </div>
                <div class="input-group pull-left" style="width: 1px; margin-right: 3px" id="watched-stats-days-selection">
                    <span class="input-group-addon btn-dark inactive">Last</span>
                    <input type="number" class="form-control" name="watched-stats-days" id="watched-stats-days" value="${config['home_stats_length']}" min="1" data-default="30" data-toggle="tooltip" title="Min: 1 day" />
                    <span class="input-group-addon btn-dark inactive">days</span>
                </div>
                <div class="input-group pull-left" style="width: 1px; margin-right: 3px" id="watched-stats-count-selection">
                    <span class="input-group-addon btn-dark inactive">Top</span>
                    <input type="number" class="form-control" name="watched-stats-count" id="watched-stats-count" value="${config['home_stats_count']}" min="1" max="10" data-default="5" data-toggle="tooltip" title="Min: 1 item<br>Max: 10 items" />
                    <span class="input-group-addon btn-dark inactive">items</span>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div id="home-stats" class="home-platforms">
                <div class="text-muted"><i class="fa fa-refresh fa-spin"></i> Loading stats...</div>
                <br>
            </div>
        </div>
    </div>
    % elif section == 'library_stats':
    <div class="row">
        <div class="col-md-12">
            <div class="home-padded-header padded-header" id="library-statistics-header">
                <h3 class="pull-left">Library Statistics</h3>
                <span class="btn btn-dark active" style="cursor: default">${config['pms_name']}</span>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div id="library-stats" class="library-platforms">
                <div class="text-muted"><i class="fa fa-refresh fa-spin"></i> Loading stats...</div>
                <br>
            </div>
        </div>
    </div>
    % elif section == 'recently_added':
    <div class="row">
        <div class="col-md-12">
            <div class="home-padded-header padded-header">
                <h3 class="pull-left">Recently Added</h3>
                <ul class="nav nav-header nav-dashboard pull-right" style="margin-top: -3px;">
                    <li>
                        <a href="#" id="recently-added-page-left" class="paginate btn-gray disabled" data-id="+1"><i class="fa fa-lg fa-chevron-left"></i></a>
                    </li>
                    <li>
                        <a href="#" id="recently-added-page-right" class="paginate btn-gray disabled" data-id="-1"><i class="fa fa-lg fa-chevron-right"></i></a>
                    </li>
                </ul>
                <div class="btn-group pull-left" data-toggle="buttons" id="recently-added-toggles" style="margin-right: 3px">
                    <label class="btn btn-dark active" id="recently-added-label-all">
                        <input type="radio" name="recently-added-toggle" id="recently-added-toggle-all" value="" autocomplete="off"> All
                    </label>
                    <label class="btn btn-dark" id="recently-added-label-movies">
                        <input type="radio" name="recently-added-toggle" id="recently-added-toggle-movie" value="movie" autocomplete="off"> Movies
                    </label>
                    <label class="btn btn-dark" id="recently-added-label-tv">
                        <input type="radio" name="recently-added-toggle" id="recently-added-toggle-show" value="show" autocomplete="off"> TV Shows
                    </label>
                    <label class="btn btn-dark" id="recently-added-label-music">
                        <input type="radio" name="recently-added-toggle" id="recently-added-toggle-music" value="artist" autocomplete="off"> Music
                    </label>
                </div>
                <div class="input-group pull-left" style="width: 1px;" id="recently-added-count-selection">
                    <input type="number" class="form-control" name="recently-added-count" id="recently-added-count" value="${config['home_stats_recently_added_count']}" min="1" max="100" data-default="50" data-toggle="tooltip" title="Min: 1 item<br>Max: 100 items" />
                    <span class="input-group-addon btn-dark inactive">items</span>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div id="recentlyAdded" style="margin-right: -15px;">
                <div class="text-muted"><i class="fa fa-refresh fa-spin"></i> Looking for new items...</div>
                <br>
            </div>
        </div>
    </div>
    % endif
    % endfor
</div>
</%def>

<%def name="modalIncludes()">

% if _session['user_group'] == 'admin' and config['update_show_changelog']:
<div id="changelog-modal" class="modal fade wide" tabindex="-1" role="dialog" aria-labelledby="changelog-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">PlexPy Updated</h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <input type="button" class="btn btn-bright" data-dismiss="modal" value="Close">
            </div>
        </div>
    </div>
</div>
% endif

% if _session['user_group'] == 'admin':
<div id="terminate-session-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="terminate-session-modal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-remove"></i></button>
                <h4 class="modal-title">Terminate Session</h4>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p>Are you sure you want to terminate this session?</p>
                <p>
                    <strong>
                        <span id="terminate-user"></span><br />
                        <span id="terminate-title"></span><br />
                        <span id="terminate-subtitle"></span>
                    </strong>
                </p>
                <br />
                <label for="terminate-message">Terminate Message</label>
                <div class="row">
                    <div class="col-md-8" style="float: none; margin: 0 auto;">
                        <input type="text" class="form-control" id="terminate-message" name="terminate-message" value="" placeholder="The server owner has ended the stream." style="text-align: center;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-dark" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger btn-ok" data-dismiss="modal" id="confirm-terminate-session">Terminate</button>
            </div>
        </div>
    </div>
</div>
% endif

<div class="modal fade" id="ip-info-modal" tabindex="-1" role="dialog" aria-labelledby="ip-info-modal">
</div>

</%def>

<%def name="javascriptIncludes()">
<script src="${http_root}js/moment-with-locale.js"></script>
<script src="${http_root}js/jquery.scrollbar.min.js"></script>
<script>
    var date_format = 'YYYY-MM-DD';
    var time_format = 'hh:mm a';
    $.ajax({
        url: 'get_date_formats',
        type: 'GET',
        success: function (data) {
            date_format = data.date_format;
            time_format = data.time_format;
        }
    });
</script>
% if 'current_activity' in config['home_sections']:
<script>
    function currentActivityHeader() {
        $.ajax({
            url: 'get_current_activity_header',
            cache: false,
            async: true,
            complete: function (xhr, status) {
                $("#current-activity-header").html(xhr.responseText);
            }
        });
    }
    currentActivityHeader();

    function getCurrentActivity() {
        $.ajax({
            url: 'get_activity',
            type: 'GET',
            cache: false,
            async: true,
            error: function (xhr, status, error) {
                console.log(status + ': ' + error);
            },
            complete: function (xhr, status) {
                $('#dashboard-checking-activity').remove();

                var current_activity;
                try {
                    current_activity = $.parseJSON(xhr.responseText);
                } catch (e) {
                    console.log(status + ': ' + e);
                    current_activity = null;
                }

                if (!(current_activity)) {
                    $('#currentActivity').html('<div id="dashboard-no-activity" class="text-muted">There was an error communicating with your Plex Server.</div>');
                    return
                }

                var stream_count = parseInt(current_activity.stream_count);
                var sessions = current_activity.sessions;

                if (stream_count) {
                    $('#dashboard-no-activity').remove();

                    sessions.forEach(function (s) {
                        var key = s.session_key;
                        var session_id = s.session_id;
                        var instance = $('#instance-' + key);

                        // Create a new instance if it doesn't exist
                        if (!(instance.length)) {
                            getActivityInstance(s);
                            return;
                        }

                        // Update play state icon
                        switch (s.state) {
                            case 'playing':
                                var state_icon = '<i class="fa fa-fw fa-play"></i>&nbsp;';
                                break;
                            case 'paused':
                                var state_icon = '<i class="fa fa-fw fa-pause"></i>&nbsp;';
                                break;
                            case 'buffering':
                                var state_icon = '<i class="fa fa-fw fa-spinner"></i>&nbsp;';
                                break;
                            default:
                                var state_icon = '<i class="fa fa-fw fa-question-circle"></i>&nbsp;';
                        }
                        $('#play-state-' + key).html(state_icon);

                        // Switching tracks can be under the same session key, so need to update the info.
                        if (s.media_type === 'track') {
                            // Update if artist changed
                            if (s.grandparent_rating_key != instance.data('grandparent_rating_key')) {
                                $('#background-' + key).css('background-image', 'url(pms_image_proxy?img=' + s.art + '&width=500&height=280&fallback=art&refresh=true)');
                                $('#metadata-grandparent_title-' + key)
                                    .attr('href', 'info?rating_key=' + s.grandparent_rating_key)
                                    .attr('title', s.grandparent_title)
                                    .text(s.grandparent_title);
                            }
                            // Update cover if album changed
                            if (s.parent_rating_key != instance.data('parent_rating_key')) {
                                $('#poster-' + key).css('background-image', 'url(pms_image_proxy?img=' + s.parent_thumb + '&width=300&height=300&fallback=poster&refresh=true)');
                                $('#poster-url-' + key)
                                    .attr('href', 'info?rating_key=' + s.parent_rating_key)
                                    .attr('title', s.parent_title);
                                $('#metadata-parent_title-' + key)
                                    .attr('href', 'info?rating_key=' + s.parent_rating_key)
                                    .attr('title', s.parent_title)
                                    .text(s.parent_title);
                            }
                            // Update cover if track changed
                            if (s.parent_rating_key != instance.data('parent_rating_key')) {
                                $('#metadata-title-' + key)
                                    .attr('href', 'info?rating_key=' + s.rating_key)
                                    .attr('title', s.title)
                                    .text(s.title);
                            }
                        }

                        // Update the transcode state
                        var transcode_decision = '';
                        if (s.transcode_decision === 'transcode') {
                            var throttled = (s.throttled == '1') ? ' (Throttled)' : ' (Speed: ' + s.transcode_speed + ')';
                            transcode_decision = 'Transcode' + throttled;
                        } else if (s.transcode_decision === 'copy') {
                            transcode_decision = 'Direct Stream';
                        } else {
                            transcode_decision = 'Direct Play';
                        }
                        $('#transcode_decision-' + key).html(transcode_decision);

                        var transcode_container = '';
                        if (s.stream_container_decision === 'transcode') {
                            transcode_container = 'Transcode (' + s.container.toUpperCase() + ' &rarr; ' + s.stream_container.toUpperCase() + ')';
                        } else {
                            transcode_container = 'Direct Play (' + s.container.toUpperCase() + ')';
                        }
                        $('#transcode_container-' + key).html(transcode_container);

                        var video_decision = '';
                        if (['movie', 'episode', 'clip'].indexOf(s.media_type) > -1 && s.video_decision != '') {
                            switch (s.video_resolution.toLowerCase()) {
                                case 'sd':
                                    var v_res = 'SD';
                                    break;
                                case '4k':
                                    var v_res = '4k';
                                    break;
                                default:
                                    var v_res = s.video_resolution + 'p'
                            }
                            switch (s.stream_video_resolution.toLowerCase()) {
                                case 'sd':
                                    var sv_res = 'SD';
                                    break;
                                case '4k':
                                    var sv_res = '4k';
                                    break;
                                default:
                                    var sv_res = s.stream_video_resolution + 'p'
                            }
                            if (s.stream_video_decision === 'transcode') {
                                var hw_d = (s.transcode_hw_requested === '1' && s.transcode_hw_decode && s.transcode_hw_full_pipeline === '0') ? ' (HW)' : ' (HW)';
                                var hw_e = (s.transcode_hw_requested === '1' && s.transcode_hw_encode && s.transcode_hw_full_pipeline === '1') ? ' (HW)' : ' (HW)';
                                video_decision = 'Transcode (' + s.video_codec.toUpperCase() + hw_d + ' ' + v_res + ' &rarr; ' + s.stream_video_codec.toUpperCase() + hw_e + ' ' + sv_res + ')';
                            } else if (s.stream_video_decision === 'copy') {
                                video_decision = 'Direct Stream (' + s.stream_video_codec.toUpperCase() + ' ' + sv_res + ')';
                            } else {
                                video_decision = 'Direct Play (' + s.video_codec.toUpperCase() + ' ' + v_res + ')';
                            }
                        } else if (s.media_type === 'photo') {
                            video_decision = 'Direct Play (' + s.width + 'x' + s.height + ')';
                        }
                        $('#video_decision-' + key).html(video_decision);

                        var audio_decision = '';
                        if (['movie', 'episode', 'clip', 'track'].indexOf(s.media_type) > -1 && s.audio_codec) {
                            var a_codec = (s.audio_codec === 'truehd') ? 'TrueHD' : s.audio_codec.toUpperCase();
                            var sa_codec = (s.stream_audio_codec === 'truehd') ? 'TrueHD' : s.stream_audio_codec.toUpperCase();
                            if (s.stream_audio_decision === 'transcode') {
                                audio_decision = 'Transcode (' + a_codec + ' ' + s.audio_channel_layout.split('(')[0] + ' &rarr; ' + sa_codec + ' ' + s.stream_audio_channel_layout + ')';
                            } else if (s.stream_audio_decision === 'copy') {
                                audio_decision = 'Direct Stream (' + sa_codec + ' ' + s.stream_audio_channel_layout + ')';
                            } else {
                                audio_decision = 'Direct Play (' + a_codec + ' ' + s.audio_channel_layout.split('(')[0] + ')';
                            }
                        }
                        $('#audio_decision-' + key).html(audio_decision);

                        var subtitle_decision = 'None';
                        if (['movie', 'episode', 'clip'].indexOf(s.media_type) > -1 && s.subtitles == '1') {
                            if (s.stream_subtitle_decision === 'transcode') {
                                subtitle_decision = 'Transcode (' + s.subtitle_codec.toUpperCase() + ' &rarr; ' + s.stream_subtitle_codec.toUpperCase() + ')';
                            } else if (s.stream_subtitle_decision === 'copy') {
                                subtitle_decision = 'Direct Stream (' + s.subtitle_codec.toUpperCase() + ')';
                            } else if (s.stream_subtitle_decision === 'burn') {
                                subtitle_decision = 'Burn (' + s.subtitle_codec.toUpperCase() + ')';
                            } else {
                                subtitle_decision = 'Direct Play (' + s.subtitle_codec.toUpperCase() + ')';
                            }
                        }
                        $('#subtitle_decision-' + key).html(subtitle_decision);

                        // Update the stream quality profile and bandwidth
                        if (s.media_type != 'photo') {
                            var br = parseInt(s.stream_bitrate) || 'Unknown';
                            var br_units = 'kbps'
                            if (br != "Unknown" && br > 1000) {
                                br = (br / 1000).toFixed(1);
                                br_units = 'Mbps';
                            }
                            $('#stream_quality-' + key).html(s.quality_profile + ' (' + br + ' ' + br_units + ')');
                        } else {
                            $('#stream_quality-' + key).html(s.quality_profile);
                        }
                        $('#optimized_version-' + key).html(s.optimized_version_profile);

                        var bw = parseInt(s.bandwidth) || 'Unknown';
                        var bw_units = 'kbps'
                        if (bw != "Unknown" && bw > 1000) {
                            bw = (bw / 1000).toFixed(1);
                            bw_units = 'Mbps';
                        }
                        $('#stream-bandwidth-' + key).html(bw + ' ' + bw_units);

                        // Update the stream progress times
                        $('#stream-eta-' + key).html(moment().add(parseInt(s.duration) - parseInt(s.view_offset), 'milliseconds').format(time_format));
                        $('#stream-view-offset-' + key).html(millisecondsToMinutes(s.view_offset, false));

                        // Update the progress bars, percent - 3 because of 3px padding-right
                        $('#buffer-bar-' + key).width(parseInt(s.transcode_progress) - 3 + '%').html(s.transcode_progress + '%')
                            .attr('data-original-title', 'Transcoder Progress ' + s.transcode_progress + '%');
                        $('#progress-bar-' + key).width(parseInt(s.progress_percent) - 3 + '%').html(s.progress_percent + '%')
                            .attr('data-original-title', 'Stream Progress ' + s.progress_percent + '%');

                        // Add temporary class so we know which instances are still active
                        instance.addClass('updated-temp');
                    });

                    // Remove finished instances
                    var all_instances = $('div[id^=instance-]');
                    all_instances.each(function (i, instance) {
                        if ($(instance).hasClass('updated-temp')) {
                            $(instance).removeClass('updated-temp');
                        } else {
                            $(instance).find('[data-toggle=tooltip]').tooltip('destroy');
                            $(instance).remove();
                        }
                    });

                } else {
                    $('#currentActivity').html('<div id="dashboard-no-activity" class="text-muted">Nothing is currently being played.</div>');
                }
            }
        });
    }

    function getActivityInstance(session) {
        $.ajax({
            url: 'get_current_activity_instance',
            type: 'GET',
            cache: false,
            async: true,
            data: session,
            complete: function(xhr, status) {
                $('#currentActivity').append(xhr.responseText);
                $('#instance-' + session.session_key + ' .dashboard-activity-info-scroller').scrollbar();
                $('#instance-' + session.session_key + ' [data-toggle=tooltip]').tooltip({ container: 'body', placement: 'right', delay: 50 })
                $('#terminate-button-icon-' + session.session_key).tooltip('destroy').tooltip({ container: 'body', placement: 'left', delay: 50 });
            }
        });
    }

    getCurrentActivity();
    setInterval(function () {
        currentActivityHeader();
        getCurrentActivity();
    }, 2000);

    $('#currentActivity').on('click', '.external_ip-modal', function () {
        $.get('get_ip_address_details', {
            ip_address: $(this).data('ip')
        }).then(function (jqXHR) {
            $("#ip-info-modal").html(jqXHR);
        });
    });

    % if _session['user_group'] == 'admin':
    // Terminate session
    $('#currentActivity').on('click', '.dashboard-activity-terminate-session', function (e) {
        e.preventDefault();
        var session_id = $(this).data('id');
        var key = $(this).data('key');
        var instance = $('#instance-' + key);

        $('#terminate-user').text(instance.find('.dashboard-activity-metadata-user').text());
        $('#terminate-title').text(instance.find('.dashboard-activity-metadata-title').text());
        $('#terminate-subtitle').text(instance.find('.dashboard-activity-metadata-subtitle').text());

        $('#terminate-session-modal').modal();
        $('#terminate-session-modal').one('click', '#confirm-terminate-session', function () {
            var message = $('#terminate-message').val();

            showMsg('Terminating session', true);

            $.ajax({
                url: 'terminate_session',
                data: {
                    session_id: session_id,
                    message: message
                },
                async: true,
                success: function (data) {
                    if (data.result === 'success') {
                        setTimeout(function() {
                            currentActivityHeader();
                            getCurrentActivity();
                            showMsg('<i class="fa fa-check"></i> ' + data.message, false, true, 5000);
                        }, 2500);
                    } else {
                        showMsg('<i class="fa fa-exclamation-circle"></i> ' + data.message, false, true, 5000, true);
                    }
                }
            });
        });
    });
    % endif
</script>
% endif
% if 'watch_stats' in config['home_sections']:
<script>
    function getHomeStats(time_range, stats_type, stats_count) {
        showMsg("Loading watch statistics...", true, false, 0);

        $.ajax({
            url: 'home_stats',
            type: 'GET',
            cache: false,
            async: true,
            data: {
                time_range: time_range,
                stats_type: stats_type,
                stats_count: stats_count
            },
            complete: function (xhr, status) {
                $("#home-stats").html(xhr.responseText);
                $('#ajaxMsg').fadeOut();
            }
        });
    }

    var time_range = $('#watched-stats-days').val();
    var stats_type = $('input[name=watched-stats-type]:checked', '#watch-stats-toggles').val();
    var stats_count = $('#watched-stats-count').val();
    getHomeStats(time_range, stats_type, stats_count);

    $('input[name=watched-stats-type]').change(function () {
        stats_type = $(this).filter(':checked').val();
        getHomeStats(time_range, stats_type, stats_count);
        $.post('set_home_stats_config', { stats_type: stats_type });
    });
    $('#watched-stats-days').change(function () {
        forceMinMax($(this));
        time_range = $(this).val();
        getHomeStats(time_range, stats_type, stats_count);
        $.post('set_home_stats_config', { time_range: time_range });
    });
    $('#watched-stats-count').change(function () {
        forceMinMax($(this));
        stats_count = $(this).val();
        getHomeStats(time_range, stats_type, stats_count);
        $.post('set_home_stats_config', { stats_count: stats_count });
    });

    $('#watched-stats-days').tooltip({ container: 'body', placement: 'top', html: true });
    $('#watched-stats-count').tooltip({ container: 'body', placement: 'top', html: true });
</script>
% endif
% if 'library_stats' in config['home_sections']:
<script>
    function getLibraryStats() {
        $.ajax({
            url: 'library_stats',
            type: 'GET',
            cache: false,
            async: true,
            data: { },
            complete: function (xhr, status) {
                $("#library-stats").html(xhr.responseText);
            }
        });
    }
    getLibraryStats();
</script>
% endif
% if 'recently_added' in config['home_sections']:
<script>
    function recentlyAdded(recently_added_count, recently_added_type) {
        showMsg("Loading recently added items...", true, false, 0);

        $.ajax({
            url: 'get_recently_added',
            type: 'GET',
            async: true,
            data: {
                count: recently_added_count,
                type: recently_added_type 
            },
            complete: function (xhr, status) {
                $("#recentlyAdded").html(xhr.responseText);
                $('#ajaxMsg').fadeOut();
                highlightAddedScrollerButton();
            }
        });
    }
    var recently_added_count = $('#recently-added-count').val();
    var recently_added_type = '';
    recentlyAdded(recently_added_count, recently_added_type);

    function highlightAddedScrollerButton() {
        var scroller = $("#recently-added-row-scroller");
        var numElems = scroller.find("li:visible").length;
        scroller.width(numElems * 175);
        if (scroller.width() > $("body").find(".container-fluid").width()) {
            $("#recently-added-page-right").removeClass("disabled");
        } else {
            $("#recently-added-page-right").addClass("disabled");
        }
    }

    $(window).resize(function () {
        highlightAddedScrollerButton();
    });

    var leftTotal = 0;
    $(".paginate").click(function (e) {
        e.preventDefault();
        var scroller = $("#recently-added-row-scroller");
        var containerWidth = $("body").find(".container-fluid").width();
        var scrollAmount = $(this).data("id") * parseInt((containerWidth - 15) / 175) * 175;
        var leftMax = Math.min(-parseInt(scroller.width()) + Math.abs(scrollAmount), 0);

        leftTotal = Math.max(Math.min(leftTotal + scrollAmount, 0), leftMax);
        scroller.animate({ left: leftTotal }, 250);

        if (leftTotal == 0) {
            $("#recently-added-page-left").addClass("disabled").blur();
        } else {
            $("#recently-added-page-left").removeClass("disabled");
        }

        if (leftTotal == leftMax) {
            $("#recently-added-page-right").addClass("disabled").blur();
        } else {
            $("#recently-added-page-right").removeClass("disabled");
        }
    });

    $('#recently-added-toggles').on('change', function () {
        $('#recently-added-toggles > label').removeClass('active');
        selected_filter = $('input[name=recently-added-toggle]:checked', '#recently-added-toggles');
        $(selected_filter).closest('label').addClass('active');
        recently_added_type = $(selected_filter).val();
        recentlyAdded(recently_added_count, recently_added_type);
    });

    $('#recently-added-count').change(function () {
        forceMinMax($(this));
        recently_added_count = $(this).val();
        recentlyAdded(recently_added_count, recently_added_type);
        $.post('set_home_stats_config', { recently_added_count: recently_added_count });
    });

    $('#recently-added-count').tooltip({ container: 'body', placement: 'top', html: true });
</script>
% endif
% if _session['user_group'] == 'admin' and config['update_show_changelog']:
<script>
    $.ajax({
        url: 'get_changelog',
        data: {
            latest_only: true, 
            update_shown: true
        },
        cache: false,
        async: true,
        complete: function (xhr, status) {
            $("#changelog-modal .modal-body").html(xhr.responseText);
            $('#changelog-modal').modal();
        }
    });
</script>
% endif
</%def>