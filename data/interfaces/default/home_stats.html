<%doc>
USAGE DOCUMENTATION :: PLEASE LEAVE THIS AT THE TOP OF THIS FILE

For Mako templating syntax documentation please visit: http://docs.makotemplates.org/en/latest/

Filename:           home_stats.html
Version:            0.1
Variable names:     data [array]

data[array_index] :: Usable parameters

data['stat_id']     Returns the name of the stat. Either 'top_tv', 'top_movies', 'popular_tv', 'popular_movies', 'top_user' or 'top_platform'
data['stat_type']   Returns the type of the stat. Either 'total_plays' or 'total_duration'
data['rows']        Returns an array containing stat data

data[array_index]['rows'] :: Usable parameters

row_id                  Return the db row id for a metadata item if one exists

== Only if 'stat_id' is 'top_tv' or 'popular_tv' ==
grandparent_thumb       Returns location of the item's thumbnail. Use with pms_image_proxy.
rating_key              Returns the unique identifier for the media item.
title                   Returns the title for the associated stat.

== Only if 'stat_id' is 'top_tv' or 'top_movies' or 'top_user' or 'top_platform' ==
total_plays             Returns the count for the associated stat.
total_duration          Returns the total duration for the associated stat.

== Only of 'stat_id' is 'popular_tv' or 'popular_movies' ==
users_watched           Returns the count for the associated stat.

== Only if 'stat_id' is 'top_user' ==
thumb                   Returns url of the user's gravatar. Returns '' if none exists.
user                    Returns the username for the associated stat.
user_id                 Returns the user id for the associated stat.
friendly_name           Returns the friendly name of the user for the associated stat.

== Only if 'stat_id' is 'top_platform' ==
platform_type           Returns the platform name for the associated stat.

DOCUMENTATION :: END
</%doc>

<%!
    from plexpy import helpers

    # Human readable duration
    def hd(minutes):
        if int(minutes) > 60:
            hours = int(helpers.cast_to_float(minutes) / 60)
            minutes = int(helpers.cast_to_float(minutes) % hours)
            if minutes > 0:
                return "<h3>" + str(hours) + "</h3><p>hrs</p><h3>" + str(minutes) + "</h3><p>mins</p>"
            else:
                return "<h3>" + str(hours) + "</h3><p>hrs</p>"
        else:
            return "<h3>" + minutes + "</h3><p>mins</p>"
%>

% if data:
% if data[0]['rows'] or data[2]['rows']:
<ul class="list-unstyled">
    % for a in data:
    % if a['stat_id'] == 'top_tv' and a['rows']:
    <div class="home-platforms-instance">
        <li>
            <div class="home-platforms-instance-info">
                <div class="home-platforms-instance-name">
                    <h4>Most Watched TV</h4>
                    <h5><a href="info?item_id=${a['rows'][0]['rating_key']}">
                        ${a['rows'][0]['title']}
                    </a></h5>
                </div>
                <div class="user-platforms-instance-playcount">
                    % if a['stat_type'] == 'total_plays':
                    <h3>${a['rows'][0]['total_plays']}</h3>
                    <p> plays</p>
                    % else:
                    ${a['rows'][0]['total_duration'] | hd}
                    % endif
                </div>
            </div>
            <a href="info?item_id=${a['rows'][0]['rating_key']}">
                % if a['rows'][0]['grandparent_thumb']:
                <div class="home-platforms-instance-poster">
                    <div class="poster-face" style="background-image: url(pms_image_proxy?img=${a['rows'][0]['grandparent_thumb']}&width=300&height=450&fallback=poster);"></div>
                </div>
                % else:
                <div class="home-platforms-instance-poster">
                    <div class="poster-face" style="background-image: url(interfaces/default/images/poster.png);"></div>
                </div>
                % endif
            </a>
        </li>
    </div>
    % elif a['stat_id'] == 'popular_tv' and a['rows']:
    <div class="home-platforms-instance">
        <li>
            <div class="home-platforms-instance-info">
                <div class="home-platforms-instance-name">
                    <h4>Most Popular TV</h4>
                    <h5><a href="info?item_id=${a['rows'][0]['rating_key']}">
                        ${a['rows'][0]['title']}
                    </a></h5>
                </div>
                <div class="user-platforms-instance-playcount">
                    <h3>${a['rows'][0]['users_watched']}</h3>
                    <p> users</p>
                </div>
            </div>
            <a href="info?item_id=${a['rows'][0]['rating_key']}">
                % if a['rows'][0]['grandparent_thumb'] != '':
                <div class="home-platforms-instance-poster">
                    <div class="poster-face" style="background-image: url(pms_image_proxy?img=${a['rows'][0]['grandparent_thumb']}&width=300&height=450&fallback=poster);"></div>
                </div>
                % else:
                <div class="home-platforms-instance-poster">
                    <div class="poster-face" style="background-image: url(interfaces/default/images/poster.png);"></div>
                </div>
                % endif
            </a>
        </li>
    </div>
    % elif a['stat_id'] == 'top_movies' and a['rows']:
    <div class="home-platforms-instance">
        <li>
            <div class="home-platforms-instance-info">
                <div class="home-platforms-instance-name">
                    <h4>Most Watched Movie</h4>
                    <h5><a href="info?item_id=${a['rows'][0]['rating_key']}">
                        ${a['rows'][0]['title']}
                    </a></h5>
                </div>
                <div class="user-platforms-instance-playcount">
                    % if a['stat_type'] == 'total_plays':
                    <h3>${a['rows'][0]['total_plays']}</h3>
                    <p> plays</p>
                    % else:
                    ${a['rows'][0]['total_duration'] | hd}
                    % endif
                </div>
            </div>
            <a href="info?item_id=${a['rows'][0]['rating_key']}">
                % if a['rows'][0]['thumb']:
                <div class="home-platforms-instance-poster">
                    <div class="poster-face" style="background-image: url(pms_image_proxy?img=${a['rows'][0]['thumb']}&width=300&height=450&fallback=poster);"></div>
                </div>
                % else:
                <div class="home-platforms-instance-poster">
                    <div class="poster-face" style="background-image: url(interfaces/default/images/poster.png);"></div>
                </div>
                % endif
            </a>
        </li>
    </div>
    % elif a['stat_id'] == 'popular_movies' and a['rows']:
    <div class="home-platforms-instance">
        <li>
            <div class="home-platforms-instance-info">
                <div class="home-platforms-instance-name">
                    <h4>Most Popular Movie</h4>
                    <h5><a href="info?item_id=${a['rows'][0]['rating_key']}">
                        ${a['rows'][0]['title']}
                    </a></h5>
                </div>
                <div class="user-platforms-instance-playcount">
                    <h3>${a['rows'][0]['users_watched']}</h3>
                    <p> users</p>
                </div>
            </div>
            <a href="info?item_id=${a['rows'][0]['rating_key']}">
                % if a['rows'][0]['thumb']:
                <div class="home-platforms-instance-poster">
                    <div class="poster-face" style="background-image: url(pms_image_proxy?img=${a['rows'][0]['thumb']}&width=300&height=450&fallback=poster);"></div>
                </div>
                % else:
                <div class="home-platforms-instance-poster">
                    <div class="poster-face" style="background-image: url(interfaces/default/images/poster.png);"></div>
                </div>
                % endif
            </a>
        </li>
    </div>
    % elif a['stat_id'] == 'top_users' and a['rows']:
    <div class="home-platforms-instance">
        <li>
            <div class="home-platforms-instance-info">
                <div class="home-platforms-instance-name">
                    <h4>Most Active User</h4>
                    <h5>
                        % if a['rows'][0]['user_id']:
                        <a href="user?user_id=${a['rows'][0]['user_id']}">
                        % else:
                        <a href="user?user=${a['rows'][0]['user']}">
                        % endif
                        ${a['rows'][0]['friendly_name']}
                        </a>
                    </h5>
                </div>
                <div class="user-platforms-instance-playcount">
                    % if a['stat_type'] == 'total_plays':
                    <h3>${a['rows'][0]['total_plays']}</h3>
                    <p> plays</p>
                    % else:
                    ${a['rows'][0]['total_duration'] | hd}
                    % endif
                </div>
            </div>
            % if a['rows'][0]['user_id']:
            <a href="user?user_id=${a['rows'][0]['user_id']}">
            % else:
            <a href="user?user=${a['rows'][0]['user']}">
            % endif
                % if a['rows'][0]['thumb'] != '':
                <div class="home-platforms-instance-poster">
                    <div class="home-platforms-instance-oval" style="background-image: url(${a['rows'][0]['thumb']});">
                </div>
                % else:
                <div class="home-platforms-instance-poster">
                    <div class="home-platforms-instance-oval" style="background-image: url(interfaces/default/images/gravatar-default.png);">
                </div>
                % endif
            </a>
        </li>
    </div>
    % elif a['stat_id'] == 'top_platforms' and a['rows']:
    <div class="home-platforms-instance">
        <li>
            <div class="home-platforms-instance-info">
                <div class="home-platforms-instance-name">
                    <h4>Most Active Platform</h4>
                    <h5>${a['rows'][0]['platform_type']}</h5>
                </div>
                <div class="user-platforms-instance-playcount">
                    % if a['stat_type'] == 'total_plays':
                    <h3>${a['rows'][0]['total_plays']}</h3>
                    <p> plays</p>
                    % else:
                    ${a['rows'][0]['total_duration'] | hd}
                    % endif
                </div>
            </div>
            <div id="platform-stat" class="home-platforms-instance-poster">
                <div class="home-platforms-instance-box" style="background-image: url(interfaces/default/images/platforms/default.png);">
            </div>
        </li>
    </div>
    <script>
        $("#platform-stat").html("<div class='home-platforms-instance-box' style='background-image: url(" + getPlatformImagePath('${a['rows'][0]['platform_type']}') + ");'>");
    </script>
    % endif
    % endfor
</ul>
% else:
<div class="text-muted">No stats for selected period.</div><br>
% endif
<script>
        $(function () {
            if (HCTest() == true) {
                $('#home-stats .poster-face').each(function () {
                    background_img = $(this).attr('style').split('(')[1].split(')')[0];
                    $(this).html('<img src="' + background_img + '" width="80" height="120"/>');
                })
                $('#home-stats .home-platforms-instance-oval, #home-stats .home-platforms-instance-box').each(function () {
                    background_img = $(this).attr('style').split('(')[1].split(')')[0];
                    $(this).html('<img src="' + background_img + '" width="80" height="80"/>');
                })
            }
        })
</script>
% else:
<div class="text-muted">Unable to retrieve data from database. Please check your <a href="settings">settings</a>.
</div><br>
% endif